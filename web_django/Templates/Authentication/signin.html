{% extends "index.html" %}
{% load static %}
{% load socialaccount %}
<!-- Modal -->
{% block modal-signin %}
<div class="modal">
  <div class="modal__overlay"></div>
  <div class="modal__body"> 
    <div class="auth-form">
      <div class="auth-form__container">
        <div class="auth-form__header">
          <a href="{% url 'signin' %}{% if request.GET.next %}?next={{ request.GET.next }}{% endif %}" class="auth-form__register">
            <h3>Đăng nhập</h3>
          </a>
          <a href="{% url 'signup' %}{% if request.GET.next %}?next={{ request.GET.next }}{% endif %}" class="auth-form__switch">
            <span>Đăng ký</span>
          </a>
        </div>
        <form action="{% url 'signin' %}" method="POST">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ next }}">
          <div class="auth-form__form">
            <div class="auth-form__group">
                <input type="email" id="Email" name="Email" class="auth-form__input" placeholder="Email" required/>
                <input type="password" id="password" name ="password" class="auth-form__input" placeholder="Mật khẩu" required/>
            </div>
            {% if messages %}
              <div class="auth-messages">
                {% for message in messages %}
                  <div class="auth-message{{ message.tags }}">
                    {{ message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            <div class="auth__form-help">
                <a href="{% url 'reset_password' %}?next={{ next|urlencode }}" class="auth__form-help-link">
                <span class="help-text-forget">Quên mật khẩu</span>
              </a>
              <a href="{% url 'guide' %}" class="auth__form-help-link">
                <span class="help-text-guide">Cần trợ giúp?</span>
              </a>
            </div>
            <div class="auth-form__control">
              {% if next %}
              <a href="{{ next }}" class="btn btn--back">Trở lại</a>
              {% else %}
              <a href="{% url 'main' %}" class="btn btn--back">Trở lại</a>
              {% endif %}
              <button type="submit" class="btn btn--primary">Đăng nhập</button>
            </div>
          </div>
        </form>
      </div>
      <div class="auth-form__social">
        <a href="{% provider_login_url 'google' %}" class="btn btn-with-gg-icon" id="googleLoginBtn" onclick="openGooglePopup(event)">
          <i class="auth__icon fa-brands fa-google"></i>
          <span class="auth__title"> Đăng nhập với Google </span>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
function openGooglePopup(event) {
  event.preventDefault();
  
  const googleUrl = event.currentTarget.href;
  const width = 500;
  const height = 650;
  const left = (screen.width - width) / 2;
  const top = (screen.height - height) / 2;
  
  const popup = window.open(
    googleUrl,
    'Google Login',
    `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes,status=no,location=no`
  );
  
  // Đơn giản: Chỉ cần check khi popup đóng, sau đó reload
  const checkPopup = setInterval(function() {
    if (!popup || popup.closed) {
      clearInterval(checkPopup);
      
      console.log('[PARENT] Popup closed, reloading page...');
      
      // Đóng modal đăng nhập
      const modal = document.querySelector('.modal');
      if (modal) {
        modal.style.display = 'none';
      }
      
      // Reload trang sau 300ms để đảm bảo session đã được lưu
      setTimeout(function() {
        window.location.reload();
      }, 300);
    }
  }, 300);
  
  // Focus vào popup
  if (popup) {
    popup.focus();
  }
}
</script>

{% endblock %}