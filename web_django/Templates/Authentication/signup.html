{% extends "index.html" %}
{% load static %}
{% load socialaccount %}
<!-- Modal -->
{% block modal-signup %}
  <div class="modal">
    <div class="modal__overlay"></div>
    <div class="modal__body"> 
      <div class="auth-form">
        <div class="auth-form__container">
          <div class="auth-form__header">
            <a href="{% url 'signin' %}{% if request.GET.next %}?next={{ request.GET.next }}{% endif %}" class="auth-form__register">
              <h3>Đăng nhập</h3>
            </a>
            <a href="{% url 'signup' %}{% if request.GET.next %}?next={{ request.GET.next }}{% endif %}" class="auth-form__switch">
              <span>Đăng ký</span>
            </a>
          </div>
          <form action="{% url 'signup' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next }}">
            <div class="auth-form__form">
              <div class="auth-form__group">
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="auth-form__input"
                  placeholder="Email"
                  required/
                />
                <input
                  type="password"
                  id="password1"
                  name="password1"
                  class="auth-form__input"
                  placeholder="Mật khẩu"
                  required/
                />
                <input
                  type="password"
                  id="password2"
                  name="password2"
                  class="auth-form__input"
                  placeholder="Nhập lại mật khẩu"
                  required/
                />
              </div>
              {% if messages %}
                <div class="auth-messages">
                  {% for message in messages %}
                    <div class="auth-message {{ message.tags }}">
                      {{ message }}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="auth-form__policy">
                <p class="auth-form__policy-text">
                  Bằng việc đăng ký tài khoản, bạn đã đồng ý với
                  <a href="{% url 'policy' %}" target="_blank" class="auth-form__policy-link">
                    <span>Điều khoản dịch vụ</span>
                  </a>
                  &
                  <a href="{% url 'policy' %}" target="_blank" class="auth-form__policy-link">
                    <span>Chính sách bảo mật</span>
                  </a>
                  của chúng tôi
                </p>
              </div>
              <div class="auth-form__control">
                {% if next %}
                <a href="{{ next }}" class="btn btn--back">Trở lại</a>
                {% else %}
                <a href="{% url 'main' %}" class="btn btn--back">Trở lại</a>
                {% endif %}
                <button type="submit" class="btn btn--primary">Đăng ký</button>
              </div>
            </div>
          </form>
        </div>
        <div class="auth-form__social">
          <a href="{% provider_login_url 'google' %}" class="btn btn-with-gg-icon" onclick="openGooglePopup(event)">
            <i class="auth__icon fa-brands fa-google"></i>
            <span class="auth__title"> Đăng ký với Google </span>
          </a>
        </div>
      </div>
    </div>
  </div>  

<script>
function openGooglePopup(event) {
  event.preventDefault();
  
  const googleUrl = event.currentTarget.href;
  const width = 500;
  const height = 650;
  const left = (screen.width - width) / 2;
  const top = (screen.height - height) / 2;
  
  const popup = window.open(
    googleUrl,
    'Google Login',
    `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes,status=no,location=no`
  );
  
  // Đơn giản: Chỉ cần check khi popup đóng, sau đó reload
  const checkPopup = setInterval(function() {
    if (!popup || popup.closed) {
      clearInterval(checkPopup);
      
      console.log('[PARENT] Popup closed, reloading page...');
      
      // Đóng modal đăng ký
      const modal = document.querySelector('.modal');
      if (modal) {
        modal.style.display = 'none';
      }
      
      // Reload trang sau 300ms để đảm bảo session đã được lưu
      setTimeout(function() {
        window.location.reload();
      }, 300);
    }
  }, 300);
  
  // Focus vào popup
  if (popup) {
    popup.focus();
  }
}
</script>
      
      // Reload trang chính để cập nhật trạng thái đăng nhập
      window.location.href = '/';
    }
  }, 300);
  
  // Focus vào popup
  if (popup) {
    popup.focus();
  }
}
</script>

{% endblock %}