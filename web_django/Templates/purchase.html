{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/purchase.css' %}">
</head>
<body>
    <div class="container">
        <div class="max-w-6xl">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-steps">
                    <div class="step">
                        <div class="step-number active" id="step1">1</div>
                        <span class="step-label active" id="label1">Gi·ªè h√†ng</span>
                    </div>
                    <div class="step-line" id="line1"></div>
                    <div class="step">
                        <div class="step-number inactive" id="step2">2</div>
                        <span class="step-label inactive" id="label2">Thanh to√°n</span>
                    </div>
                    <div class="step-line" id="line2"></div>
                    <div class="step">
                        <div class="step-number inactive" id="step3">3</div>
                        <span class="step-label inactive" id="label3">Ho√†n t·∫•t</span>
                    </div>
                </div>
            </div>
            <!-- Cart Page -->
            <div id="cartPage">
                <div class="cart-grid">
                    <!-- Cart Items -->
                    <div>
                        <div class="cart-section">
                            <h2 class="section-title">
                                <i class="fas fa-shopping-cart"></i>
                               Gi·ªè h√†ng c·ªßa b·∫°n ({{ order.get_cart_items }} s·∫£n ph·∫©m)
                            </h2>
                            <!-- Hi·ªÉn th·ªã c√°c s·∫£n ph·∫©m trong gi·ªè h√†ng -->
                            {% for item in order.orderitem_set.all %}
                            <div class="cart-item">
                                <div class="item-content">
                                    <div class="item-image">
                                        <img src="{{ item.product.imageURL }}" alt="{{ item.product.name }}">
                                    </div>
                                    <div class="item-details">
                                        <div class="item-header">
                                            <div>
                                                <h3 class="item-name">{{ item.product.name }}</h3>
                                                <p class="item-variant">{{ item.product.brand }} - {{ item.product.country }}</p>
                                                <p class="item-sku">M√£: {{ item.product.id }} | Size: <span style="font-weight: 600; color: #ee4d2d;">{{ item.size }}</span></p>
                                            </div>
                                            <button class="delete-btn" data-item="{{ item.id }}" data-action="delete">
                                                <i class="fas fa-trash" style="font-size: 1rem;"></i>
                                            </button>
                                        </div>

                                        <div class="item-badges">
                                            <span class="badge badge-stock">
                                                <i class="fas fa-box"></i> C√≤n h√†ng
                                            </span>
                                            <span class="badge badge-delivery">
                                                <i class="fas fa-truck"></i> Giao 2-3 ng√†y
                                            </span>
                                            {% if item.product.discount_percent > 0 %}
                                            <span class="badge badge-discount">
                                                <i class="fas fa-tag"></i> -{{ item.product.discount_percent }}%
                                            </span>
                                            {% endif %}
                                        </div>

                                        <div class="item-footer">
                                            <div class="item-price">
                                                {% if item.product.new_price %}
                                                <span class="original-price">{{ item.product.old_price|intcomma }}ƒë</span>
                                                <span class="current-price">{{ item.product.new_price|intcomma }}ƒë</span>
                                                {% else %}
                                                <span class="current-price">{{ item.product.old_price|intcomma }}ƒë</span>
                                                {% endif %}
                                            </div>

                                            <div class="quantity-control">
                                                <span class="qty-label">S·ªë l∆∞·ª£ng:</span>
                                                <div class="qty-buttons">
                                                    <button class="qty-btn" data-item="{{ item.id }}" data-action="remove">‚àí</button>
                                                    <span class="qty-number">{{ item.quantity }}</span>
                                                    <button class="qty-btn" data-item="{{ item.id }}" data-action="add">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Voucher -->
                        <div class="voucher-section">
                            <h3 class="voucher-header">
                                <i class="fas fa-tag"></i>
                                M√£ gi·∫£m gi√°
                            </h3>
                            <div class="voucher-input-group">
                                <input type="text" class="voucher-input" id="voucherInput" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°">
                                <button class="voucher-btn" onclick="applyVoucher()">√Åp d·ª•ng</button>
                            </div>
                            <div class="voucher-applied" id="voucherApplied" style="display: none;">
                                <i class="fas fa-check-circle"></i>
                                <span>ƒê√£ √°p d·ª•ng m√£ <strong id="appliedCode"></strong> - Gi·∫£m <strong id="discountAmount"></strong></span>
                            </div>
                            {% if active_coupons %}
                            <div class="voucher-hint">
                                üí° C√°c m√£ c√≥ s·∫µn: 
                                {% for coupon in active_coupons %}
                                <strong style="color: #3b82f6;">{{ coupon.code }}</strong>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="voucher-hint">
                                üí° Hi·ªán t·∫°i ch∆∞a c√≥ m√£ gi·∫£m gi√°
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div>
                        <div class="order-summary">
                            <h3 class="summary-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>

                            <div class="summary-row">
                                <span>T·∫°m t√≠nh</span>
                                <span id="subtotal">{{ order.get_cart_total|intcomma }}ƒë</span>
                            </div>
                            <div class="summary-row">
                                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                                <span>30.000ƒë</span>
                            </div>
                            <div class="summary-row discount" id="discountRow" style="display: none;">
                                <span>Gi·∫£m gi√°</span>
                                <span id="discountTotal">-50.000ƒë</span>
                            </div>
                            <div class="summary-row total">
                                <span class="label">T·ªïng c·ªông</span>
                                <span class="amount" id="grandTotal">{{ order.get_cart_total|add:30000|intcomma }}ƒë</span>
                            </div>

                            <button class="checkout-btn" onclick="goToCheckout()">
                                Ti·∫øn h√†nh thanh to√°n
                                <i class="fas fa-arrow-right"></i>
                            </button>

                            <div class="trust-badges">
                                <div class="trust-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Mi·ªÖn ph√≠ ƒë·ªïi tr·∫£ trong 7 ng√†y</span>
                                </div>
                                <div class="trust-item">
                                    <i class="fas fa-truck"></i>
                                    <span>Giao h√†ng to√†n qu·ªëc</span>
                                </div>
                                <div class="trust-item">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Thanh to√°n an to√†n & b·∫£o m·∫≠t</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Page -->
            <div id="checkoutPage" style="display: none;">
                <div class="checkout-grid">
                    <!-- Checkout Form -->
                    <div>
                        <!-- Shipping Info -->
                        <div class="cart-section" style="margin-bottom: 1.5rem;">
                            <h3 class="section-title">
                                <i class="fas fa-map-marker-alt"></i>
                                Th√¥ng tin giao h√†ng
                            </h3>

                            {% if address_info.street %}
                            <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                <span>ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·∫øu c·∫ßn.</span>
                            </div>
                            {% endif %}

                            <form id="checkoutForm" method="POST" action="">
                                {% csrf_token %}
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">H·ªç v√† t√™n <span style="color: #ef4444;">*</span></label>
                                        <input type="text" name="full_name" class="form-input" placeholder="Nguy·ªÖn VƒÉn A" value="{{ user_info.full_name }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span style="color: #ef4444;">*</span></label>
                                        <input type="tel" name="phone" class="form-input" placeholder="0901234567" value="{{ user_info.phone }}" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Email <span style="color: #ef4444;">*</span></label>
                                    <input type="email" name="email" class="form-input" placeholder="email@example.com" value="{{ user_info.email }}" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">ƒê·ªãa ch·ªâ <span style="color: #ef4444;">*</span></label>
                                    <input type="text" name="street" class="form-input" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" value="{{ address_info.street }}" required>
                                </div>

                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label class="form-label">T·ªânh/Th√†nh <span style="color: #ef4444;">*</span></label>
                                        <input type="text" name="city" class="form-input" placeholder="H√† N·ªôi" value="{{ address_info.city }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Qu·∫≠n/Huy·ªán <span style="color: #ef4444;">*</span></label>
                                        <input type="text" name="district" class="form-input" placeholder="Ba ƒê√¨nh" value="{{ address_info.district }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ph∆∞·ªùng/X√£ <span style="color: #ef4444;">*</span></label>
                                        <input type="text" name="ward" class="form-input" placeholder="Ph∆∞·ªùng Ph√∫c X√°" value="{{ address_info.ward }}" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Ghi ch√∫ (t√πy ch·ªçn)</label>
                                    <textarea name="note" class="form-textarea" rows="3" placeholder="Ghi ch√∫ v·ªÅ ƒë∆°n h√†ng..."></textarea>
                                </div>
                            </form>
                        </div>

                        <!-- Payment Method -->
                        <div class="cart-section">
                            <h3 class="section-title">
                                <i class="fas fa-credit-card"></i>
                                Ph∆∞∆°ng th·ª©c thanh to√°n
                            </h3>

                            <label class="payment-option selected">
                                <input type="radio" name="payment_method" value="COD" form="checkoutForm" checked>
                                <div class="payment-info">
                                    <div class="payment-title">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                    <div class="payment-desc">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                </div>
                            </label>

                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="BANK" form="checkoutForm">
                                <div class="payment-info">
                                    <div class="payment-title">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                                    <div class="payment-desc">Chuy·ªÉn kho·∫£n qua VietQR ho·∫∑c s·ªë t√†i kho·∫£n</div>
                                </div>
                            </label>

                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="EWALLET" form="checkoutForm">
                                <div class="payment-info">
                                    <div class="payment-title">V√≠ ƒëi·ªán t·ª≠ (Momo, ZaloPay)</div>
                                    <div class="payment-desc">Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Order Summary (Checkout) -->
                    <div>
                        <div class="order-summary">
                            <h3 class="summary-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h3>

                            <!-- Items -->
                            <div style="margin-bottom: 1rem;">
                                {% for item in order.orderitem_set.all %}
                                <div class="order-item-small">
                                    <div class="item-thumb">
                                        <img src="{{ item.product.imageURL }}" alt="{{ item.product.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                    </div>
                                    <div class="item-info-small">
                                        <div class="item-name-small">{{ item.product.name }}</div>
                                        <div class="item-variant-small">{{ item.product.brand }} - {{ item.product.country }} | Size: {{ item.size }}</div>
                                        <div class="item-price-small">
                                            {% if item.product.new_price %}
                                            {{ item.product.new_price|intcomma }}ƒë √ó {{ item.quantity }}
                                            {% else %}
                                            {{ item.product.old_price|intcomma }}ƒë √ó {{ item.quantity }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-bottom: 1rem;">
                                <div class="summary-row">
                                    <span>T·∫°m t√≠nh</span>
                                    <span id="checkoutSubtotal">{{ order.get_cart_total|intcomma }}ƒë</span>
                                </div>
                                <div class="summary-row">
                                    <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                                    <span>30.000ƒë</span>
                                </div>
                                <div class="summary-row discount" id="checkoutDiscountRow" style="display: none;">
                                    <span>Gi·∫£m gi√°</span>
                                    <span id="checkoutDiscountTotal">-50.000ƒë</span>
                                </div>
                                <div class="summary-row total">
                                    <span class="label">T·ªïng c·ªông</span>
                                    <span class="amount" id="checkoutGrandTotal">{{ order.get_cart_total|add:30000|intcomma }}ƒë</span>
                                </div>
                            </div>

                            <button type="submit" form="checkoutForm" class="checkout-btn">
                                <i class="fas fa-check-circle"></i>
                                Ho√†n t·∫•t ƒë∆°n h√†ng
                            </button>

                            <button type="button" class="back-btn" onclick="backToCart()">
                                ‚Üê Quay l·∫°i gi·ªè h√†ng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let appliedDiscount = {{ order.get_discount_amount|default:0 }};
        const subtotalAmount = {{ order.get_cart_total|default:0 }};
        const shippingFee = {{ shipping_fee|default:30000 }};
        
        // Load existing coupon if any
        {% if order.coupon %}
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('appliedCode').textContent = '{{ order.coupon.code }}';
            document.getElementById('discountAmount').textContent = '{{ order.get_discount_amount|intcomma }}ƒë';
            document.getElementById('voucherApplied').style.display = 'flex';
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('discountTotal').textContent = '-{{ order.get_discount_amount|intcomma }}ƒë';
            updateTotal();
        });
        {% endif %}

        function applyVoucher() {
            const code = document.getElementById('voucherInput').value.trim().toUpperCase();
            
            if (!code) {
                alert('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!');
                return;
            }
            
            // Call API
            fetch('/order/apply-coupon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ 'code': code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appliedDiscount = data.discount_amount;
                    document.getElementById('appliedCode').textContent = data.code;
                    document.getElementById('discountAmount').textContent = appliedDiscount.toLocaleString('vi-VN') + 'ƒë';
                    document.getElementById('voucherApplied').style.display = 'flex';
                    document.getElementById('discountRow').style.display = 'flex';
                    document.getElementById('discountTotal').textContent = '-' + appliedDiscount.toLocaleString('vi-VN') + 'ƒë';
                    document.getElementById('voucherInput').value = '';
                    updateTotal();
                } else {
                    alert(data.error || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            });
        }

        function updateTotal() {
            const total = subtotalAmount + shippingFee - appliedDiscount;
            document.getElementById('grandTotal').textContent = total.toLocaleString('vi-VN') + 'ƒë';
            document.getElementById('checkoutGrandTotal').textContent = total.toLocaleString('vi-VN') + 'ƒë';
            
            if (appliedDiscount > 0) {
                document.getElementById('checkoutDiscountRow').style.display = 'flex';
                document.getElementById('checkoutDiscountTotal').textContent = '-' + appliedDiscount.toLocaleString('vi-VN') + 'ƒë';
            }
        }

        function goToCheckout() {
            // Hide cart page
            document.getElementById('cartPage').style.display = 'none';
            // Show checkout page
            document.getElementById('checkoutPage').style.display = 'block';
            
            // Update progress bar
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').innerHTML = '<i class="fas fa-check" style="font-size: 0.875rem;"></i>';
            document.getElementById('label1').classList.remove('active');
            document.getElementById('label1').classList.add('inactive');
            
            document.getElementById('line1').classList.add('active');
            
            document.getElementById('step2').classList.remove('inactive');
            document.getElementById('step2').classList.add('active');
            document.getElementById('label2').classList.remove('inactive');
            document.getElementById('label2').classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function backToCart() {
            // Show cart page
            document.getElementById('cartPage').style.display = 'block';
            // Hide checkout page
            document.getElementById('checkoutPage').style.display = 'none';
            
            // Update progress bar
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').textContent = '1';
            document.getElementById('label1').classList.remove('inactive');
            document.getElementById('label1').classList.add('active');
            
            document.getElementById('line1').classList.remove('active');
            
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('inactive');
            document.getElementById('label2').classList.remove('active');
            document.getElementById('label2').classList.add('inactive');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Payment option selection
        document.addEventListener('DOMContentLoaded', function() {
            const paymentOptions = document.querySelectorAll('.payment-option');
            paymentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    paymentOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                });
            });
        });

        // Quantity buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('qty-btn') || e.target.closest('.qty-btn')) {
                const btn = e.target.closest('.qty-btn') || e.target;
                let itemId = btn.dataset.item;
                let action = btn.dataset.action;
                console.log('Item:', itemId, 'Action:', action);

                // G·ªçi API Django ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                fetch('/order/update_item/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ 'itemId': itemId, 'action': action })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Updated:', data);
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t gi·ªè h√†ng!');
                });
            }

            // Delete button
            if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                const btn = e.target.closest('.delete-btn') || e.target;
                let itemId = btn.dataset.item;
                console.log('Delete item:', itemId);
                
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?')) {
                    // G·ªçi API x√≥a
                    fetch('/order/update_item/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({ 'itemId': itemId, 'action': 'delete' })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Deleted:', data);
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi x√≥a s·∫£n ph·∫©m!');
                    });
                }
            }
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>